# Enhanced Prediction Metrics Backtester

This Python script (`prediction_metrics_backtesting.py`) provides a flexible backtesting framework for evaluating trading strategies based on prediction metrics. It allows you to simulate trading activity using a CSV file containing prediction data and analyze the strategy's performance.

## Features

* Backtesting of trading strategies using prediction metrics from a CSV file
* Highly configurable backtesting parameters
* Calculation of various performance metrics (e.g., Sharpe ratio, max drawdown, win rate)
* Generation of detailed backtest reports and visualizations (equity curve, drawdown chart, etc.)
* Flexibility to load data from various sources using custom data loading functions

## Installation

1. **Clone the repository:**

   ```bash
   git clone <your_repository_url>
   cd <your_repository_directory>
   ```

2. **Install dependencies:**

   It's recommended to use a virtual environment to manage dependencies.

   ```bash
   python -m venv venv
   source venv/bin/activate  # On Linux/macOS
   venv\Scripts\activate  # On Windows
   ```

   Install the required Python packages using `pip`:

   ```bash
   pip install pandas numpy matplotlib seaborn
   ```

   Alternatively, you can install the dependencies using the provided `requirements.txt` file:

   ```bash
   pip install -r requirements.txt
   ```

## Usage

### 1. Prepare Your Data

The input data should be in a CSV file. The backtester requires specific columns to function correctly.

#### Required Columns

* `timestamp` (required):
    * Description: Timestamp of the data point or prediction. This is crucial for ordering the data.
    * Data Type: `datetime` (or a string that pandas can convert to datetime).
    * Format: Recommended format is "YYYY-MM-DD HH:MM:SS" or "YYYY-MM-DD".
    * Example: "2024-04-12 10:00:00", "2024-04-12"
* `signal` (required):
    * Description: Trading signal generated by your strategy or model.
    * Data Type: `string`
    * Values: Typically, "buy" or "sell". The script can be adapted for other signal values, but this requires code modification.
    * Example: "buy", "sell"
* `last_trade_price` (conditional):
    * Description: Price of the asset at the time of the signal.
    * Data Type: `float`
    * Conditional: Required for backtesting based on actual price data. If `last_trade_price` is not provided, you *must* provide `actual_pct_change` to simulate price movements.
    * Example: 150.25
* `actual_pct_change` (conditional):
    * Description: Actual percentage change in price that occurred *after* the signal.
    * Data Type: `float`
    * Conditional: Required to simulate price movements if `last_trade_price` is not consistently available.
    * Example: 0.1 (represents 0.1%)
* `model_name` (optional):
    * Description: Name of the model that generated the signal (useful if you're backtesting multiple models).
    * Data Type: `string`
    * Example: "LSTM_model_1", "CNN_model_a"
* `confidence_width` (optional):
    * Description: A measure of the model's confidence in the signal. Lower values typically indicate higher confidence.
    * Data Type: `float`
    * Example: 0.05, 0.12
* `would_hit_tp` (optional):
    * Description: Indicates if the take profit level would have been hit after the signal.
    * Data Type: `bool` (True/False)
    * Example: True, False
* `would_hit_sl` (optional):
    * Description: Indicates if the stop loss level would have been hit after the signal.
    * Data Type: `bool` (True/False)
    * Example: True, False

#### Example Data (CSV)

```csv
timestamp,signal,last_trade_price,actual_pct_change,model_name,confidence_width,would_hit_tp,would_hit_sl
2024-04-12 09:30:00,buy,150.00,0.05,LSTM_model_1,0.04,True,False
2024-04-12 10:00:00,sell,150.75,-0.02,LSTM_model_1,0.03,False,False
2024-04-12 10:30:00,buy,149.50,0.08,LSTM_model_2,0.06,True,False
2024-04-12 11:00:00,sell,151.00,-0.03,LSTM_model_2,0.05,False,True
2024-04-12 11:30:00,buy,150.50,0.02,LSTM_model_1,0.02,True,False
2024-04-12 12:00:00,sell,150.80,-0.01,LSTM_model_1,0.04,False,False
```

### 2. Run the Backtester

You can run the backtester from the command line using the `enhanced_prediction_metrics_backtesting.py` script.

```bash
python prediction_metrics_backtesting.py <csv_path> [options]
```

#### Arguments

* `<csv_path>` (required): Path to the input CSV file containing prediction data.
* `--initial-capital` (optional): Starting capital for the backtest.
  * Data Type: float
  * Default: 100000
  * Example: `--initial-capital 1000000`
* `--position-size` (optional): Position size as a fraction of available capital (0 to 1).
  * Data Type: float
  * Default: 0.2
  * Example: `--position-size 0.1` (for 10% of capital)
* `--take-profit` (optional): Take profit target as a percentage.
  * Data Type: float
  * Default: 0.5 (represents 0.5%)
  * Example: `--take-profit 0.2` (for 0.2%)
* `--stop-loss` (optional): Stop loss percentage.
  * Data Type: float
  * Default: 0.3 (represents 0.3%)
  * Example: `--stop-loss 0.1` (for 0.1%)
* `--risk-reward` (optional): Target risk/reward ratio. This is used to calculate the take profit level if `--use-risk-reward` is specified.
  * Data Type: float
  * Default: 2.0
  * Example: `--risk-reward 3.0`
* `--use-risk-reward` (optional): If included, the take profit level will be calculated based on the risk-reward ratio and the stop-loss level.
  * Data Type: bool (flag)
  * Default: False (if not included)
  * Example: `--use-risk-reward`
* `--commission` (optional): Commission fee per trade.
  * Data Type: float
  * Default: 1.0
  * Example: `--commission 0.5`
* `--slippage` (optional): Slippage percentage applied to entry and exit prices.
  * Data Type: float
  * Default: 0.01 (represents 0.01%)
  * Example: `--slippage 0.005`
* `--model` (optional): Filter the backtest for a specific model name.
  * Data Type: string
  * Example: `--model LSTM_model_1`
* `--confidence` (optional): Confidence threshold. Trades are only considered if the confidence_width is less than or equal to this value. (Lower confidence_width often means higher confidence).
  * Data Type: float
  * Example: `--confidence 0.05`
* `--output-dir` (optional): Directory to save output files (reports, charts, etc.).
  * Data Type: string
  * Default: backtest_results
  * Example: `--output-dir my_backtest_results`
* `--data-loader` (optional): Path to a Python file containing a custom `load_data` function. This allows you to load data from sources other than CSV files.
  * Data Type: string (path to a Python file)
  * Example: `--data-loader my_data_loader.py`

#### Examples

Basic backtest with default settings:

```bash
python prediction_metrics_backtesting.py data.csv
```

Backtest with specific parameters:

```bash
python prediction_metrics_backtesting.py data.csv --initial-capital 50000 --take-profit 0.1 --stop-loss 0.05 --commission 0.25
```

Backtest for a specific model:

```bash
python prediction_metrics_backtesting.py data.csv --model LSTM_model_1 --output-dir model_1_results
```

Backtest with a custom data loading function:

```bash
python prediction_metrics_backtesting.py data.csv --data-loader my_data_loader.py
```

### 3. Custom Data Loading

The `--data-loader` argument provides a way to load data from sources other than CSV files. You can create your own `load_data` function to connect to databases, APIs, or other data formats.

1. Create a Python file (e.g., `my_data_loader.py`) containing a function named `load_data`.
2. The `load_data` function must accept one argument: the `csv_path` (or your equivalent data source identifier). This path will be passed to your custom function.
3. The function must return a pandas DataFrame. The DataFrame should have the columns described in the "Prepare Your Data" section.
4. Pass the path to your Python file using the `--data-loader` argument when running the script.

#### Example 1: Loading from a SQLite Database

```python
# my_data_loader.py
import pandas as pd
import sqlite3

def load_data(db_path):
    """
    Loads data from a SQLite database.

    Args:
        db_path (str): Path to the SQLite database file.

    Returns:
        pd.DataFrame: The loaded data.
    """
    conn = sqlite3.connect(db_path)
    df = pd.read_sql_query("SELECT * FROM predictions", conn)
    conn.close()
    return df
```

#### Example 2: Loading from a CSV with a Different Date Format

```python
# another_data_loader.py
import pandas as pd

def load_data(csv_path):
    """
    Loads data from a CSV with a different date format and column names.

    Args:
        csv_path (str): Path to the CSV file.

    Returns:
        pd.DataFrame: The loaded data.
    """
    df = pd.read_csv(csv_path, parse_dates=['date'], date_format='%m/%d/%Y %H:%M')
    df.rename(columns={'date': 'timestamp', 'action': 'signal', 'price': 'last_price'}, inplace=True)
    return df
```

#### Example 3: Loading data from an API

```python
# api_data_loader.py
import pandas as pd
import requests

def load_data(api_url):
    """
    Loads data from a REST API.

    Args:
        api_url (str): The URL of the API endpoint.

    Returns:
        pd.DataFrame: The loaded data.
    """
    response = requests.get(api_url)
    response.raise_for_status()  # Raise an exception for bad status codes
    data = response.json()
    df = pd.DataFrame(data)
    # Assuming the API returns data that needs minimal processing
    return df
```

### Output

The script generates the following output files in the specified `output_dir`:

* `backtest_report.txt`: A text file containing a summary of the backtest results, including performance metrics.
* `trades.csv`: A CSV file with details of each trade executed during the backtest (entry/exit times, prices, profit/loss, etc.).
* `equity_curve.csv`: A CSV file containing the equity curve data, showing the capital's evolution over time.
* PNG files with visualizations:
  * `equity_curve.png`: Chart of the equity curve.
  * `drawdown_chart.png`: Chart of the drawdown over time.
  * `monthly_returns.png`: Heatmap of monthly returns.
  * `trade_distribution.png`: Histogram showing the distribution of trade profit/loss percentages.

## Example Results

Here's an example of what the backtest results might look like:

```
Backtest Performance Report
=========================

Configuration:
  Initial Capital: $100,000.00
  Position Size: 20.0% of capital
  Take Profit: 0.50%
  Stop Loss: 0.30%
  Risk/Reward Ratio: 2.0
  Commission: $1.00 per trade
  Slippage: 0.01%

Performance Summary:
  Total Trades: 245
  Win Rate: 58.37%
  Profit Factor: 1.87
  Net Profit: 42.35%
  Total Return: 42.35%
  Benchmark Return: 15.20%
  CAGR: 18.75%
  Max Drawdown: -8.24%
  Sharpe Ratio: 1.65
  Final Equity: $142,350.82
```

## Contributing

Contributions are welcome! Here's how you can contribute:

1. Fork the repository on GitHub.
2. Create a new branch for your feature or bug fix.
3. Make your changes and commit them with clear, concise commit messages.
4. Submit a pull request to the main branch.

Please make sure your code follows the existing style and includes appropriate tests.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Author

Nathaniel William Huff / NathanielWilliam117@gmail.com